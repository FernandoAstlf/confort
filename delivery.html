<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entrega</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #f8f8f8;
        }

        .delivery-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            background-color: white;
        }

        h1 {
            color: #007BFF;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th {
            background-color: #007BFF;
            color: white;
            padding: 10px;
            text-align: left;
            border: 1px solid #ddd;
        }

        tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        td {
            padding: 8px;
            border: 1px solid #ddd;
        }

        tr:hover {
            background-color: #ddd;
            transition: background-color 0.3s ease;
        }

        .sub-row {
            display: none;
            background-color: #e6e6e6;
        }

        .sub-row > td:first-child {
            background-color: #f8f8f8;
            border: none;
        }

        .expand-button {
            cursor: pointer;
        }
    </style>
    <script>
        async function loadDeliveryTableData() {
            try {
                const response = await fetch('https://confort.azurewebsites.net/orders'); // Substitua pelo endereço correto do seu servidor
                const data = await response.json();

                const filteredData = data.filter(order => order.productionChecked === 1);

                const groupedData = {};
                filteredData.forEach(order => {
                    if (!groupedData[order.reciboName]) {
                        groupedData[order.reciboName] = {
                            clientName: order.clientName,
                            reciboName: order.reciboName,
                            deliveryDate: order.deliveryDate,
                            productionChecked: order.productionChecked,
                            deliveredDate: order.deliveredDate,
                            products: []
                        };
                    }
                    groupedData[order.reciboName].products.push({
                        quantidade: order.quantidade,
                        produto: order.produto,
                        delivered: order.deliveryChecked === 1
                    });
                });

                addOrdersToDeliveryTable(Object.values(groupedData));
            } catch (error) {
                console.error("Erro ao carregar dados:", error);
            }
        }

       function addOrdersToDeliveryTable(orders) {
            const tbody = document.getElementById('deliveryTable').getElementsByTagName('tbody')[0];
        
            orders.forEach(order => {
                const newRow = tbody.insertRow();
        
                const nameCell = newRow.insertCell(0);
                const orderCell = newRow.insertCell(1);
                const deliveryDateCell = newRow.insertCell(2);
                const statusCell = newRow.insertCell(3);
                const deliveredDateCell = newRow.insertCell(4);
                
                nameCell.textContent = order.clientName;
                orderCell.innerHTML = `${order.reciboName} <span class="expand-button" onclick="toggleSubRows(this)">[+]</span>`;
                deliveryDateCell.textContent = order.deliveryDate;
                statusCell.innerHTML = `<input type="checkbox" data-id="${order.reciboName}" onclick="updateDeliveryStatus(this)" ${order.productionChecked === 1 ? 'checked' : ''}>`;
                deliveredDateCell.textContent = order.deliveredDate;
        
                order.products.forEach(product => {
                    const subRow = tbody.insertRow();
                    subRow.classList.add('sub-row');
        
                    const emptyCell = subRow.insertCell(0);
                    const productCell = subRow.insertCell(1);
                    productCell.colSpan = 4;
        
                    productCell.innerHTML = `
                        ${product.quantidade} ${product.produto} 
                        <input type="checkbox" data-id="${order.reciboName}-${product.produto}" onclick="updateDeliveryStatus(this)" ${product.delivered ? 'checked' : ''}>
                    `;

                });
            });
        }

        function toggleSubRows(button) {
            const mainRow = button.closest('tr');
            let nextRow = mainRow.nextElementSibling;
        
            while (nextRow && nextRow.classList.contains('sub-row')) {
                if (nextRow.style.display === 'none' || !nextRow.style.display) {
                    nextRow.style.display = 'table-row';
                    button.textContent = '[-]';
                } else {
                    nextRow.style.display = 'none';
                    button.textContent = '[+]';
                }
                nextRow = nextRow.nextElementSibling;
            }
        }
        
        function toggleSubRowCheckboxes(checkbox) {
            const mainRow = checkbox.closest('tr');
            let nextRow = mainRow.nextElementSibling;
        
            while (nextRow && nextRow.classList.contains('sub-row')) {
                const productCheckbox = nextRow.querySelector('input[type="checkbox"]');
                productCheckbox.checked = checkbox.checked;
                nextRow = nextRow.nextElementSibling;
            }
        }
        async function updateDeliveryStatus(checkbox) {
            const isChecked = checkbox.checked;
            const orderId = checkbox.getAttribute('data-id');
            console.log("orderId:", orderId);
        
            // Atualize a coluna deliveryDate se isChecked for true
            const deliveryDate = isChecked ? new Date().toISOString() : null;
        
            try {
                const response = await fetch(`/update-delivery/${orderId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        deliveryChecked: isChecked ? 1 : 0,
                        deliveryDate: deliveryDate
                    })
                });
        
                if (response.ok) {
                    console.log("Status de entrega atualizado com sucesso!");
                } else {
                    console.error("Erro ao atualizar status de entrega:", await response.text());
                    // Reverter a checkbox se a atualização falhar
                    checkbox.checked = !isChecked;
                }
            } catch (error) {
                console.error("Erro ao atualizar status de entrega:", error);
                // Reverter a checkbox se a atualização falhar
                checkbox.checked = !isChecked;
            }
        }



        window.onload = loadDeliveryTableData;
    </script>
</head>

<body>
    <div class="delivery-container">
        <h1>Entrega</h1>
        <table id="deliveryTable">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Pedido</th>
                    <th>Data para a Entrega</th>
                    <th>Status</th>
                    <th>Data Entregue</th>
                </tr>
            </thead>
            <tbody>
                <!-- As linhas da tabela serão preenchidas dinamicamente aqui -->
            </tbody>
        </table>
    </div>
</body>

</html>
